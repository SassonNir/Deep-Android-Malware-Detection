import os
import shutil
import subprocess


def create_dirs():
    # Input dir for applications before running DroidBot test.
    if os.path.exists(input_dir_path):
        shutil.rmtree(input_dir_path)

    # Output dir for applications after running DroidBot test.
    if os.path.exists(output_dir_path):
        shutil.rmtree(output_dir_path)

    # Result files after the comparison of chain_assess.py
    if os.path.exists(result_compare_path):
        shutil.rmtree(result_compare_path)

    # Create dirs
    os.mkdir(input_dir_path)
    os.mkdir(output_dir_path)
    os.mkdir(result_compare_path)


if __name__ == '__main__':
    """
        Run example: python3 comparison_runner.py
        
        In Before-Apps directory, put all .apk files before modifications.
        In After-Apps directory, put all .apk files after modifications.
    """
    before_apps_dir_path = './Before-Apps'
    after_apps_dir_path = './After-Apps'

    input_dir_path = './Input'
    output_dir_path = './Output'
    result_compare_path = './Result-Compare'

    # Create all relevant directories
    create_dirs()

    for before_app_name in os.listdir(before_apps_dir_path):
        if not before_app_name.endswith('.apk'):
            continue
        # Make sure file names without '_'
        shutil.copy2(f"{before_apps_dir_path}/{before_app_name}", f"{input_dir_path}/{before_app_name.replace('_', '-')}")

    for after_app_name in os.listdir(after_apps_dir_path):
        if not after_app_name.endswith('.apk'):
            continue
        shutil.copy2(f"{after_apps_dir_path}/{after_app_name}", f"{input_dir_path}/{after_app_name[:-4]}_after.apk")

    # Run DroidBot script on Input directory
    os.system("python3 droidbot_runner.py")

    # Run comparison (chain_assess.py) on Output files
    os.system(f"python3 chain_assess.py {output_dir_path}")
